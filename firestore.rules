/**
 * @fileoverview Firestore Security Rules for the application.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for personal data and allows public read access for some shared collections like Services and Products while restricting write access to authorized users or owners.
 *
 * Data Structure:
 * - User profiles are stored in the `/users/{userId}` collection, ensuring individual user data isolation.
 * - Design orders, appointments, and quotation requests are stored as subcollections under each user's profile, further isolating user-specific information.
 * - Services and products are stored in top-level collections (`/services`, `/products`) to facilitate easy querying of all available items.  Products have a `sellerId` field for ownership.
 *
 * Key Security Decisions:
 * - Listing all users is disallowed.
 * - User-owned resources under `/users/{userId}` are accessible only to the authenticated user matching the `userId`.
 * - Services are publicly readable but writes are not allowed in this prototype.
 * - Products are publicly readable, but create/update/delete operations are restricted to the product owner (seller).
 *
 * Denormalization for Authorization:
 * - Product documents contain a `sellerId` field, which is used to authorize updates and deletes.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Enforces access control for user profiles. Only the user can read/write their own profile.
     * @path /users/{userId}
     * @allow (create) - User with ID 'user123' creates their profile.
     *   - auth.uid: 'user123'
     *   - resource.data.id: 'user123'
     * @allow (get, update, delete) - User with ID 'user123' reads/updates/deletes their profile.
     *   - auth.uid: 'user123'
     *   - resource.data.id: 'user123'
     * @deny (create) - User with ID 'user123' tries to create a profile for 'user456'.
     *   - auth.uid: 'user123'
     *   - resource.data.id: 'user456'
     * @deny (get, update, delete) - User with ID 'user123' tries to read/update/delete the profile of 'user456'.
     *   - auth.uid: 'user123'
     *   - resource.data.id: 'user456'
     * @principle Enforces document ownership and restricts access to a user's own data.
     */
    match /users/{userId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }

      allow get: if isOwner(userId);
      allow list: if false; // Disallowing listing all users

      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isOwner(userId) && resource.data.id == userId;
      allow delete: if isOwner(userId) && resource != null;
    }

    /**
     * @description Enforces access control for design orders. Only the owner can read/write their design orders.
     * @path /users/{userId}/designOrders/{designOrderId}
     * @allow (create) - User with ID 'user123' creates a design order under their profile.
     *   - auth.uid: 'user123'
     *   - resource.data.userId: 'user123'
     * @allow (get, update, delete) - User with ID 'user123' reads/updates/deletes a design order under their profile.
     *   - auth.uid: 'user123'
     *   - resource.data.userId: 'user123'
     * @deny (create) - User with ID 'user123' tries to create a design order for 'user456'.
     *   - auth.uid: 'user123'
     *   - resource.data.userId: 'user456'
     * @deny (get, update, delete) - User with ID 'user123' tries to read/update/delete a design order for 'user456'.
     *   - auth.uid: 'user123'
     *   - resource.data.userId: 'user456'
     * @principle Enforces path-based ownership for private user data.
     */
    match /users/{userId}/designOrders/{designOrderId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }

      allow get: if isOwner(userId);
      allow list: if isOwner(userId);

      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isOwner(userId) && resource.data.userId == userId && resource != null;
      allow delete: if isOwner(userId) && resource != null;
    }

    /**
     * @description Enforces access control for appointments. Only the owner can read/write their appointments.
     * @path /users/{userId}/appointments/{appointmentId}
     * @allow (create) - User with ID 'user123' creates an appointment under their profile.
     *   - auth.uid: 'user123'
     *   - resource.data.userId: 'user123'
     * @allow (get, update, delete) - User with ID 'user123' reads/updates/deletes an appointment under their profile.
     *   - auth.uid: 'user123'
     *   - resource.data.userId: 'user123'
     * @deny (create) - User with ID 'user123' tries to create an appointment for 'user456'.
     *   - auth.uid: 'user123'
     *   - resource.data.userId: 'user456'
     * @deny (get, update, delete) - User with ID 'user123' tries to read/update/delete an appointment for 'user456'.
     *   - auth.uid: 'user123'
     *   - resource.data.userId: 'user456'
     * @principle Enforces path-based ownership for private user data.
     */
    match /users/{userId}/appointments/{appointmentId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }

      allow get: if isOwner(userId);
      allow list: if isOwner(userId);

      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isOwner(userId) && resource.data.userId == userId && resource != null;
      allow delete: if isOwner(userId) && resource != null;
    }

    /**
     * @description Enforces access control for quotation requests. Only the owner can read/write their quotation requests.
     * @path /users/{userId}/quotationRequests/{quotationRequestId}
     * @allow (create) - User with ID 'user123' creates a quotation request under their profile.
     *   - auth.uid: 'user123'
     *   - resource.data.userId: 'user123'
     * @allow (get, update, delete) - User with ID 'user123' reads/updates/deletes a quotation request under their profile.
     *   - auth.uid: 'user123'
     *   - resource.data.userId: 'user123'
     * @deny (create) - User with ID 'user123' tries to create a quotation request for 'user456'.
     *   - auth.uid: 'user123'
     *   - resource.data.userId: 'user456'
     * @deny (get, update, delete) - User with ID 'user123' tries to read/update/delete a quotation request for 'user456'.
     *   - auth.uid: 'user123'
     *   - resource.data.userId: 'user456'
     * @principle Enforces path-based ownership for private user data.
     */
    match /users/{userId}/quotationRequests/{quotationRequestId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }

      allow get: if isOwner(userId);
      allow list: if isOwner(userId);

      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isOwner(userId) && resource.data.userId == userId && resource != null;
      allow delete: if isOwner(userId) && resource != null;
    }

    /**
     * @description Allows public read access to services, but restricts writes.
     * @path /services/{serviceId}
     * @allow (get, list) - Any user can read the service details.
     * @deny (create, update, delete) - No one can create, update, or delete a service.
     * @principle Allows public read access with restricted write access for services.
     */
    match /services/{serviceId} {
      allow get: if true;
      allow list: if true;

      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows public read access to products, but restricts writes to the seller.
     * @path /products/{productId}
     * @allow (get, list) - Any user can read the product details.
     * @allow (create) - User with ID 'user123' creates a product with sellerId 'user123'.
     *   - auth.uid: 'user123'
     *   - resource.data.sellerId: 'user123'
     * @allow (update, delete) - User with ID 'user123' updates/deletes a product where resource.data.sellerId is 'user123'.
     *   - auth.uid: 'user123'
     *   - resource.data.sellerId: 'user123'
     * @deny (create) - User with ID 'user123' tries to create a product with sellerId 'user456'.
     *   - auth.uid: 'user123'
     *   - resource.data.sellerId: 'user456'
     * @deny (update, delete) - User with ID 'user123' tries to update/delete a product where resource.data.sellerId is 'user456'.
     *   - auth.uid: 'user123'
     *   - resource.data.sellerId: 'user456'
     * @principle Allows public read access with owner-only writes for products.
     */
    match /products/{productId} {
      function isOwner(sellerId) {
        return request.auth != null && request.auth.uid == sellerId;
      }

      allow get: if true;
      allow list: if true;

      allow create: if request.auth != null && isOwner(request.resource.data.sellerId);
      allow update: if request.auth != null && isOwner(resource.data.sellerId) && resource != null;
      allow delete: if request.auth != null && isOwner(resource.data.sellerId) && resource != null;
    }
  }
}