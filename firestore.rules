/**
 * @fileoverview Firestore Security Rules for the application.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for personal data while allowing public read access to products and services.
 * All user-specific data (design orders, appointments, quotation requests) is nested under the `/users/{userId}` path, ensuring that only the authenticated user can access their own data.
 * Products have `sellerId`, so product listings are secure.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profile information.
 * - /users/{userId}/designOrders/{designOrderId}: Stores design orders placed by a user.
 * - /users/{userId}/appointments/{appointmentId}: Stores appointments booked by a user.
 * - /users/{userId}/quotationRequests/{quotationRequestId}: Stores quotation requests submitted by a user.
 * - /services/{serviceId}: Stores services offered by the company. Publicly readable.
 * - /products/{productId}: Stores products listed on the online marketplace. Publicly readable, owner-only writes.
 *
 * Key Security Decisions:
 * - Users can only access their own profile and associated subcollections.
 * - Products are publicly readable, but only the seller can modify them.
 * - Services are publicly readable and writable (for admins - this is not yet implemented).
 * - Listing of user profiles is disallowed.
 *
 * Denormalization for Authorization:
 * The 'products' collection leverages the 'sellerId' field to enforce ownership. No denormalization is needed in this initial prototype.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows users to read and write their own profile data.
     * @path /users/{userId}
     * @allow (create) User with UID 'user123' can create a profile with id: 'user123'.
     * @allow (get) User with UID 'user123' can read their own profile.
     * @allow (update) User with UID 'user123' can update their own profile.
     * @allow (delete) User with UID 'user123' can delete their own profile.
     * @deny (create) User with UID 'user456' cannot create a profile with id: 'user123'.
     * @deny (get) User with UID 'user456' cannot read profile of 'user123'.
     * @principle Enforces document ownership for user profiles.
     */
    match /users/{userId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
          return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if false; // Listing user profiles is not permitted.
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id; // Enforce immutability of userId.
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Allows a user to manage their own design orders.
     * @path /users/{userId}/designOrders/{designOrderId}
     * @allow (create) User with UID 'user123' can create a design order under their profile.
     * @allow (get) User with UID 'user123' can read their own design order.
     * @allow (update) User with UID 'user123' can update their own design order.
     * @allow (delete) User with UID 'user123' can delete their own design order.
     * @deny (create) User with UID 'user456' cannot create a design order under user 'user123''s profile.
     * @deny (get) User with UID 'user456' cannot read design order of user 'user123'.
     * @principle Enforces document ownership for design orders.
     */
    match /users/{userId}/designOrders/{designOrderId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
          return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Allows a user to manage their own appointments.
     * @path /users/{userId}/appointments/{appointmentId}
     * @allow (create) User with UID 'user123' can create an appointment under their profile.
     * @allow (get) User with UID 'user123' can read their own appointment.
     * @allow (update) User with UID 'user123' can update their own appointment.
     * @allow (delete) User with UID 'user123' can delete their own appointment.
     * @deny (create) User with UID 'user456' cannot create an appointment under user 'user123''s profile.
     * @deny (get) User with UID 'user456' cannot read appointment of user 'user123'.
     * @principle Enforces document ownership for appointments.
     */
    match /users/{userId}/appointments/{appointmentId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
          return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Allows a user to manage their own quotation requests.
     * @path /users/{userId}/quotationRequests/{quotationRequestId}
     * @allow (create) User with UID 'user123' can create a quotation request under their profile.
     * @allow (get) User with UID 'user123' can read their own quotation request.
     * @allow (update) User with UID 'user123' can update their own quotation request.
     * @allow (delete) User with UID 'user123' can delete their own quotation request.
     * @deny (create) User with UID 'user456' cannot create a quotation request under user 'user123''s profile.
     * @deny (get) User with UID 'user456' cannot read quotation request of user 'user123'.
     * @principle Enforces document ownership for quotation requests.
     */
    match /users/{userId}/quotationRequests/{quotationRequestId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }
      function isExistingOwner(userId) {
          return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Allows anyone to read services.  Write access is not secured yet (TODO: add admin role).
     * @path /services/{serviceId}
     * @allow (get) Any user can read any service.
     * @allow (list) Any user can list services.
     * @deny (create) Currently no condition exists to allow service creation
     * @deny (update) Currently no condition exists to allow service updates
     * @deny (delete) Currently no condition exists to allow service deletes
     */
    match /services/{serviceId} {
      allow get: if true;
      allow list: if true;
      allow create: if false; // TODO: Add admin role check
      allow update: if false; // TODO: Add admin role check
      allow delete: if false; // TODO: Add admin role check
    }

    /**
     * @description Allows anyone to read products, but only the seller can modify them.
     * @path /products/{productId}
     * @allow (get) Any user can read any product.
     * @allow (list) Any user can list products.
     * @allow (create) A user can create a product if request.auth.uid == request.resource.data.sellerId.
     * @allow (update) The seller can update their product.
     * @allow (delete) The seller can delete their product.
     * @deny (create) A user cannot create a product if request.auth.uid != request.resource.data.sellerId.
     */
    match /products/{productId} {
      function isOwner(sellerId) {
        return request.auth.uid == sellerId;
      }

      function isExistingOwner(sellerId) {
          return isOwner(sellerId) && resource != null;
      }

      allow get: if true;
      allow list: if true;
      allow create: if request.resource.data.sellerId == request.auth.uid;
      allow update: if isExistingOwner(resource.data.sellerId);
      allow delete: if isExistingOwner(resource.data.sellerId);
    }
  }
}